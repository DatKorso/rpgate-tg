# Bugfix: Enemy Counterattack Display

**–î–∞—Ç–∞:** 10 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

–ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–ª —É—Ä–æ–Ω –æ—Ç –≤—Ä–∞–≥–æ–≤ –≤ –±–æ—é, –Ω–æ –æ–± —ç—Ç–æ–º **–Ω–∏–≥–¥–µ –Ω–µ –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ** –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç GM. –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ —á—Ç–æ HP —Å–Ω–∏–∂–∞–µ—Ç—Å—è (25 ‚Üí 17), –Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∏ –Ω–µ —É–ø–æ–º–∏–Ω–∞–ª–∏—Å—å.

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã

**–°–æ–æ–±—â–µ–Ω–∏–µ (–î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
```
üé≤ **–ê—Ç–∞–∫–∞** [üé≤ 17+3 = 20] vs AC 12 ‚úÖ –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
üíî **–£—Ä–æ–Ω:** **11 HP**

–¢—ã –≤—ã—Ö–≤–∞—Ç—ã–≤–∞–µ—à—å –º–µ—á –∏–∑ –Ω–æ–∂–µ–Ω —Å —Ä–µ–∑–∫–∏–º, –∑–≤–µ–Ω—è—â–∏–º —à–µ–ª–µ—Å—Ç–æ–º —Å—Ç–∞–ª–∏...

‚ù§Ô∏è **HP:** 17/25 | üìç **–õ–æ–∫–∞—Ü–∏—è:** starting_area
```

–ò–≥—Ä–æ–∫ –ø–æ—Ç–µ—Ä—è–ª 8 HP (25 ‚Üí 17), –Ω–æ **–Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è** —á—Ç–æ –≤—Ä–∞–≥ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–æ–≤–∞–ª!

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

1. **Narrative Director** –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª `enemy_attacks` –≤ combat state JSON
2. **World State Agent** –ø—Ä–∏–º–µ–Ω—è–ª —ç—Ç–æ—Ç —É—Ä–æ–Ω –∫ –ø–µ—Ä—Å–æ–Ω–∞–∂—É (HP —Å–Ω–∏–∂–∞–ª—Å—è)
3. **Response Synthesizer –ù–ï –ü–û–ö–ê–ó–´–í–ê–õ** –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞—Ö –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏

### –ö–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã

`app/agents/response_synthesizer.py`:
```python
# –ú–µ—Ç–æ–¥ _format_enemy_attacks() –û–¢–°–£–¢–°–¢–í–û–í–ê–õ
# enemy_attacks –∏–∑ game_state –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å
```

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫

**–§–∞–π–ª:** `app/agents/response_synthesizer.py`

–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_format_enemy_attacks()`:
```python
def _format_enemy_attacks(self, game_state: dict) -> str:
    """
    Format enemy counter-attacks.
    
    Args:
        game_state: Must contain "enemy_attacks" list
        
    Returns:
        Formatted text or empty string
    """
    enemy_attacks = game_state.get("enemy_attacks", [])
    
    if not enemy_attacks:
        return ""
    
    lines = []
    lines.append("‚öîÔ∏è **–ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞ –≤—Ä–∞–≥–∞:**")
    
    for attack in enemy_attacks:
        attacker = attack.get("attacker", "–í—Ä–∞–≥")
        damage = attack.get("damage", 0)
        
        # Capitalize first letter of enemy name
        attacker_capitalized = attacker.capitalize()
        
        lines.append(f"üíî **{attacker_capitalized}** –Ω–∞–Ω–æ—Å–∏—Ç **{damage} HP** —É—Ä–æ–Ω–∞!")
    
    return "\n".join(lines)
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ execute()

–î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:

```python
# 3. Enemy attacks (if any)
enemy_attacks_text = self._format_enemy_attacks(game_state)
if enemy_attacks_text:
    parts.append(enemy_attacks_text)
```

### 3. –£–ª—É—á—à–µ–Ω Narrative Director

**–§–∞–π–ª:** `app/agents/narrative_director.py`

Narrative Director —Ç–µ–ø–µ—Ä—å **–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç combat state –ü–ï–†–ï–î narrative** –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞—Ö –≤ –ø—Ä–æ–º–ø—Ç:

```python
# Step 1: Generate combat state first (to know about enemy attacks)
game_state_updates = await self._generate_combat_state(...)

# Build enemy attack hint for narrative
enemy_attack_hint = ""
enemy_attacks = game_state_updates.get("enemy_attacks", [])
if enemy_attacks:
    enemy_attack_hint = f"\n\n–ö–û–ù–¢–†–ê–¢–ê–ö–ê –í–†–ê–ì–ê: ..."
    enemy_attack_hint += "\n–û–ü–ò–®–ò –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É –≤—Ä–∞–≥–∞ –≤ —Å–≤–æ—ë–º –Ω–∞—Ä—Ä–∞—Ç–∏–≤–µ!"
```

–¢–µ–ø–µ—Ä—å LLM **–∑–Ω–∞–µ—Ç** –æ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–µ –∏ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –µ—ë –≤ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–µ.

### 4. –û–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫

**–§–∞–π–ª:** `app/agents/narrative_director.py`

–ò–∑–º–µ–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫ –≤ combat state prompt:

```python
–°–¢–†–û–ì–û –°–õ–ï–î–£–ô –ü–†–ê–í–ò–õ–ê–ú D&D:

- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –£–°–ü–ï–®–ù–û –∞—Ç–∞–∫—É–µ—Ç ‚Üí –≤—Ä–∞–≥ –û–ë–´–ß–ù–û –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É–µ—Ç (60% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –ü–†–û–ú–ê–•–ù–£–õ–°–Ø ‚Üí –≤—Ä–∞–≥ –í–°–ï–ì–î–ê –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É–µ—Ç
- –£—Ä–æ–Ω –≤—Ä–∞–≥–∞: 5-12 HP (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –≤—Ä–∞–≥–∞)
```

**–í–ê–ñ–ù–û:** –ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∏ —Ç–µ–ø–µ—Ä—å **–ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —á–∞—â–µ**, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–π –±–æ–µ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã D&D.

## –†–µ–∑—É–ª—å—Ç–∞—Ç (–ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

**–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
üé≤ **–ê—Ç–∞–∫–∞** [üé≤ 17+3 = 20] vs AC 12 ‚úÖ –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
üíî **–£—Ä–æ–Ω:** **11 HP**

–¢—ã –≤—ã—Ö–≤–∞—Ç—ã–≤–∞–µ—à—å –º–µ—á –∏–∑ –Ω–æ–∂–µ–Ω —Å —Ä–µ–∑–∫–∏–º, –∑–≤–µ–Ω—è—â–∏–º —à–µ–ª–µ—Å—Ç–æ–º —Å—Ç–∞–ª–∏, –∏ –ª–µ–∑–≤–∏–µ 
–≤—Å–ø—ã—Ö–∏–≤–∞–µ—Ç –≤ –ø–æ–ª—É–º—Ä–∞–∫–µ. –í–∑–º–∞—Ö–Ω—É–≤ –∫–ª–∏–Ω–∫–æ–º —Å —è—Ä–æ—Å—Ç–Ω–æ–π –≥—Ä–∞—Ü–∏–µ–π, —Ç—ã –≤–æ–Ω–∑–∞–µ—à—å 
–µ–≥–æ –≤ –ø–ª–æ—Ç—å –≤—Ä–∞–≥–∞! –ù–æ –≤—Ä–∞–≥ –Ω–µ –æ—Ç—Å—Ç—É–ø–∞–µ—Ç ‚Äî –æ–Ω –Ω–∞–Ω–æ—Å–∏—Ç –æ—Ç–≤–µ—Ç–Ω—ã–π —É–¥–∞—Ä, 
–µ–≥–æ –∫–ª—ã–∫–∏ –≤–ø–∏–≤–∞—é—Ç—Å—è –≤ —Ç–≤–æ–µ –ø–ª–µ—á–æ.

‚öîÔ∏è **–ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞ –≤—Ä–∞–≥–∞:**
üíî **–í—Ä–∞–≥** –Ω–∞–Ω–æ—Å–∏—Ç **8 HP** —É—Ä–æ–Ω–∞!

‚ù§Ô∏è **HP:** 17/25 | üìç **–õ–æ–∫–∞—Ü–∏—è:** starting_area
```

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

1. ‚úÖ **Narrative –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É** ("–≤—Ä–∞–≥ –Ω–∞–Ω–æ—Å–∏—Ç –æ—Ç–≤–µ—Ç–Ω—ã–π —É–¥–∞—Ä...")
2. ‚úÖ **–Ø–≤–Ω–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∏** —Å —ç–º–æ–¥–∑–∏ –∏ —É—Ä–æ–Ω–æ–º
3. ‚úÖ **–ü–æ–Ω—è—Ç–Ω–æ –ø–æ—á–µ–º—É HP —Å–Ω–∏–∑–∏–ª—Å—è** (–±—ã–ª–æ 25, –ø–æ–ª—É—á–∏–ª 8 —É—Ä–æ–Ω–∞ ‚Üí 17)

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `app/agents/response_synthesizer.py` - –¥–æ–±–∞–≤–ª–µ–Ω `_format_enemy_attacks()`
- `app/agents/narrative_director.py` - —É–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫
- `tests/test_enemy_counterattack.py` - –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

## –¢–µ—Å—Ç—ã

–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:

```bash
uv run pytest tests/test_enemy_counterattack.py -v

# ‚úÖ test_enemy_counterattack_shown_in_message PASSED
# ‚úÖ test_no_counterattack_when_not_in_combat PASSED
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: `uv run start`
2. –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
3. –ê—Ç–∞–∫–æ–≤–∞—Ç—å –≤—Ä–∞–≥–∞: "–î–æ—Å—Ç–∞—é –º–µ—á –∏ –∞—Ç–∞–∫—É—é –≤—Ä–∞–≥–∞"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç:
   - ‚úÖ –ú–µ—Ö–∞–Ω–∏–∫—É –∞—Ç–∞–∫–∏ –∏–≥—Ä–æ–∫–∞
   - ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
   - ‚úÖ **–ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É –≤—Ä–∞–≥–∞** (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π HP –ø–µ—Ä—Å–æ–Ω–∞–∂–∞

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/SPRINT2_SPEC.md` - Multi-agent system design
- `docs/API_CONTRACTS.md` - Agent communication contracts
- `docs/BUGFIX_COMBAT_STATE_MARKDOWN.md` - Previous combat system fix
