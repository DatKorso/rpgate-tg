# Bugfix: Enemy Damage Not Applied to Player HP

**–î–∞—Ç–∞:** 7 –Ω–æ—è–±—Ä—è 2025 –≥.  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** HIGH  
**–°—Ç–∞—Ç—É—Å:** FIXED ‚úÖ

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –±–æ–µ —Å –≤—Ä–∞–≥–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–æ–ª–∫–∞–º–∏) HP –∏–≥—Ä–æ–∫–∞ **–Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è**, –∫–æ–≥–¥–∞ –≤—Ä–∞–≥–∏ –Ω–∞–Ω–æ—Å—è—Ç —É—Ä–æ–Ω. –í –Ω–∞—Ä—Ä–∞—Ç–∏–≤–µ –æ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∞—Ç–∞–∫–∞ –≤—Ä–∞–≥–∞ –∏ —É—Ä–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≤–æ–ª–∫ –Ω–∞–Ω–æ—Å–∏—Ç 9 —É—Ä–æ–Ω–∞"), –Ω–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ HP –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º.

### –ü—Ä–∏–º–µ—Ä –∏–∑ –∏–≥—Ä—ã

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

```
–ò–≥—Ä–æ–∫: –ì—Ä–æ–º–∫–æ –¥—ã—à–∞, –≤—Å—Ç–∞—é –≤ –æ–±–æ—Ä–æ–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç–æ–π–∫—É

–ë–æ—Ç:
üé≤ –ê—Ç–∞–∫–∞ [üé≤ 10+3 = 13] vs AC 12 ‚úÖ –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
üíî –£—Ä–æ–Ω: 9 HP

[–û–ø–∏—Å–∞–Ω–∏–µ: –≤–æ–ª–∫ –∞—Ç–∞–∫—É–µ—Ç –∏ –∫—É—Å–∞–µ—Ç –∏–≥—Ä–æ–∫–∞...]

‚ù§Ô∏è HP: 25/25  ‚ùå –û–®–ò–ë–ö–ê - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 16/25!
```

–£—Ä–æ–Ω –ø–æ–∫–∞–∑–∞–Ω –≤ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–µ, –Ω–æ HP –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.

---

## –ü—Ä–∏—á–∏–Ω–∞

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ—è–ª–∞ –∏–∑ –¥–≤—É—Ö –ø—Ä–æ–±–ª–µ–º:

### 1. Narrative Director –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª —É—Ä–æ–Ω —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—Å—Ç–µ

`NarrativeDirectorAgent` –æ–ø–∏—Å—ã–≤–∞–ª –∞—Ç–∞–∫–∏ –≤—Ä–∞–≥–æ–≤ **—Ç–æ–ª—å–∫–æ –≤ narrative** (—Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ), –Ω–æ **–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** –æ–± —É—Ä–æ–Ω–µ.

**–ß—Ç–æ –±—ã–ª–æ:**
```python
# narrative_director.py Output
{
    "narrative": "–í–æ–ª–∫ –∫—É—Å–∞–µ—Ç —Ç–µ–±—è, –Ω–∞–Ω–æ—Å—è 9 —É—Ä–æ–Ω–∞...",  # –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
    "game_state_updates": {
        "in_combat": True,
        "enemies": ["–≤–æ–ª–∫"]
        # ‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ damage!
    }
}
```

### 2. Orchestrator –Ω–µ –ø—Ä–∏–º–µ–Ω—è–ª —É—Ä–æ–Ω –∫ –ø–µ—Ä—Å–æ–Ω–∞–∂—É

–ú–µ—Ç–æ–¥ `_apply_mechanics_to_character` –≤ `AgentOrchestrator` –±—ã–ª –ø—É—Å—Ç–æ–π –∑–∞–≥–ª—É—à–∫–æ–π:

```python
def _apply_mechanics_to_character(self, character, mechanics, action_type):
    # For now, character stays the same
    return character  # ‚ùå –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —É—Ä–æ–Ω!
```

–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∞—Ç–∞–∫–∏ –≤—Ä–∞–≥–æ–≤.

---

## –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –û–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–æ–º–ø—Ç Narrative Director

**–§–∞–π–ª:** `app/config/prompts.py`

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `enemy_attacks` –≤ `COMBAT_STATE` JSON:

```python
COMBAT_DETECTION = """–ü–æ—Å–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–±–∞–≤—å JSON –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –±–æ–µ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
COMBAT_STATE: {
    "in_combat": true/false,
    "enemies": ["–≤—Ä–∞–≥1", "–≤—Ä–∞–≥2"],
    "combat_ended": true/false,
    "enemy_attacks": [                    # ‚úÖ –ù–û–í–û–ï –ø–æ–ª–µ
        {
            "attacker": "–∏–º—è –≤—Ä–∞–≥–∞",
            "damage": —á–∏—Å–ª–æ_—É—Ä–æ–Ω–∞
        }
    ]
}

–ü—Ä–∏–º–µ—Ä:
COMBAT_STATE: {
    "in_combat": true,
    "enemies": ["—Å–µ—Ä—ã–π –≤–æ–ª–∫", "–¥–∏–∫–∏–π –≤–æ–ª–∫"],
    "combat_ended": false,
    "enemy_attacks": [
        {"attacker": "—Å–µ—Ä—ã–π –≤–æ–ª–∫", "damage": 9}
    ]
}
```

–¢–µ–ø–µ—Ä—å LLM **–æ–±—è–∑–∞–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å** —Å–ø–∏—Å–æ–∫ –∞—Ç–∞–∫ –≤—Ä–∞–≥–æ–≤ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Ä–∞–∂–µ—Å–∫–æ–≥–æ —É—Ä–æ–Ω–∞

**–§–∞–π–ª:** `app/agents/orchestrator.py`

–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `_apply_enemy_damage`:

```python
def _apply_enemy_damage(
    self,
    character: CharacterSheet,
    enemy_attacks: list[dict]
) -> CharacterSheet:
    """Apply damage from enemy attacks to character."""
    if not enemy_attacks:
        return character
    
    for attack in enemy_attacks:
        damage = attack.get("damage", 0)
        attacker = attack.get("attacker", "unknown enemy")
        
        if damage > 0:
            actual_damage = character.take_damage(damage)
            logger.info(f"{attacker} dealt {actual_damage} damage")
    
    return character
```

–ú–µ—Ç–æ–¥:
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç —É—Ä–æ–Ω –∏–∑ –∫–∞–∂–¥–æ–π –≤—Ä–∞–∂–µ—Å–∫–æ–π –∞—Ç–∞–∫–∏
- –í—ã–∑—ã–≤–∞–µ—Ç `character.take_damage()` –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É—Ä–æ–Ω–∞
- –õ–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é –∞—Ç–∞–∫—É

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 3: –û–±–Ω–æ–≤–ª—ë–Ω workflow –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

**–§–∞–π–ª:** `app/agents/orchestrator.py`

–ò–∑–º–µ–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ `process_action`:

```python
# –î–û:
# Step 3: Update game state
updated_game_state = {...}

# Step 4: Update character (–ù–ï –†–ê–ë–û–¢–ê–õ–û)
updated_character = self._apply_mechanics_to_character(...)

# –ü–û–°–õ–ï:
# Step 3: Update game state
updated_game_state = {...}

# Step 4: Apply enemy attacks to character ‚úÖ –ù–û–í–û–ï
enemy_attacks = updated_game_state.get("enemy_attacks", [])
updated_character = self._apply_enemy_damage(character, enemy_attacks)

# Step 5: Apply other mechanics (healing, buffs, etc.)
updated_character = self._apply_mechanics_to_character(
    updated_character, ...
)
```

–¢–µ–ø–µ—Ä—å **—Å–Ω–∞—á–∞–ª–∞** –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —É—Ä–æ–Ω –æ—Ç –≤—Ä–∞–≥–æ–≤, **–ø–æ—Ç–æ–º** –¥—Ä—É–≥–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω—ã unit-—Ç–µ—Å—Ç—ã –≤ `tests/test_enemy_damage.py`:

### –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–Ω
```python
enemy_attacks = [{"attacker": "wolf", "damage": 9}]
damaged_character = orchestrator._apply_enemy_damage(character, enemy_attacks)

assert damaged_character.hp == 16  # 25 - 9 = 16 ‚úÖ
```

### –¢–µ—Å—Ç 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏
```python
enemy_attacks = [
    {"attacker": "wolf_1", "damage": 5},
    {"attacker": "wolf_2", "damage": 7}
]
# Total: 5 + 7 = 12
assert damaged_character.hp == 13  # 25 - 12 = 13 ‚úÖ
```

### –¢–µ—Å—Ç 3: HP –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å < 0
```python
enemy_attacks = [{"attacker": "dragon", "damage": 100}]
assert damaged_character.hp == 0  # –ù–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ ‚úÖ
```

### –¢–µ—Å—Ç 4: –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∞—Ç–∞–∫
```python
damaged_character = orchestrator._apply_enemy_damage(character, [])
assert damaged_character.hp == 25  # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚úÖ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ 6 —Ç–µ—Å—Ç–æ–≤ PASSED ‚úÖ

---

## –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

**–§–∞–π–ª:** `docs/API_CONTRACTS.md`

–û–±–Ω–æ–≤–ª—ë–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç `NarrativeOutput`:

```python
{
    "narrative": str,
    "game_state_updates": {
        "in_combat": bool,
        "enemies": list[str],
        "combat_ended": bool,
        "enemy_attacks": [           # ‚úÖ –ù–û–í–û–ï –ø–æ–ª–µ
            {
                "attacker": str,     # –ò–º—è –≤—Ä–∞–≥–∞
                "damage": int        # HP —É—Ä–æ–Ω
            }
        ]
    }
}
```

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–í–æ–ª–∫ –∞—Ç–∞–∫—É–µ—Ç ‚Üí –£—Ä–æ–Ω 9 ‚Üí HP: 25/25 ‚ùå
```

### –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–í–æ–ª–∫ –∞—Ç–∞–∫—É–µ—Ç ‚Üí –£—Ä–æ–Ω 9 ‚Üí HP: 16/25 ‚úÖ
```

**–¢–µ–ø–µ—Ä—å –≤—Ä–∞–∂–µ—Å–∫–∏–π —É—Ä–æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –∏–≥—Ä–æ–∫—É!**

---

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `app/config/prompts.py` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω COMBAT_DETECTION –ø—Ä–æ–º–ø—Ç
2. ‚úÖ `app/agents/orchestrator.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω `_apply_enemy_damage`, –∏–∑–º–µ–Ω—ë–Ω workflow
3. ‚úÖ `docs/API_CONTRACTS.md` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç NarrativeOutput
4. ‚úÖ `tests/test_enemy_damage.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã unit-—Ç–µ—Å—Ç—ã (–ù–û–í–´–ô —Ñ–∞–π–ª)

---

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (Sprint 3)

–í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (Sprint 2):
- –í—Ä–∞–≥–∏ ‚Äî —ç—Ç–æ **–Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏** (—Ç–µ–∫—Å—Ç), –Ω–µ –æ–±—ä–µ–∫—Ç—ã
- LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É—Ä–æ–Ω –≤—Ä–∞–≥–æ–≤ "–æ—Ç –±–∞–ª–¥—ã" –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ù–µ—Ç —Ç–æ—á–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏ –≤—Ä–∞–≥–æ–≤ (AC, HP, –∞—Ç–∞–∫–∏)

**–ü–ª–∞–Ω—ã –Ω–∞ Sprint 3:**
- –°–æ–∑–¥–∞—Ç—å `Enemy` Pydantic –º–æ–¥–µ–ª–∏ —Å HP, AC, —É—Ä–æ–Ω
- –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã (–∫—Ç–æ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º)
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–æ—á–Ω—É—é –º–µ—Ö–∞–Ω–∏–∫—É –≤—Ä–∞–∂–µ—Å–∫–∏—Ö –∞—Ç–∞–∫ (–±—Ä–æ—Å–æ–∫ d20)
- –•—Ä–∞–Ω–∏—Ç—å –≤—Ä–∞–≥–æ–≤ –≤ –ë–î (PostgreSQL)

–ù–æ –¥–ª—è MVP (Sprint 2) —Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ **–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ** ‚Äî –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–Ω –æ—Ç –≤—Ä–∞–≥–æ–≤, –∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!

---

**–ë–∞–≥ –∑–∞–∫—Ä—ã—Ç:** –í—Ä–∞–∂–µ—Å–∫–∏–π —É—Ä–æ–Ω —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ HP –∏–≥—Ä–æ–∫–∞.
